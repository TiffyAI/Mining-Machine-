<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TiffyAI Miner</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>
  <script src="https://unpkg.com/web3modal"></script>
  <style>
    /* (your existing CSS‚Ä¶) */
    .keys { margin: 10px; font-size:1.1rem; color:#0ff; }
    .keys span { font-weight:bold; }
  </style>
</head>
<body>

  <!-- your existing markup‚Ä¶ -->
  <h1>üõ† TiffyAI Miner</h1>
  <div id="tiffyCounter">‚õèÔ∏è 0.0000000 TIFFY</div>

  <!-- NEW: key counts -->
  <div class="keys">üîë Blue Keys: <span id="blueKeys">0</span></div>
  <div class="keys">ü•á Gold Keys: <span id="goldKeys">0</span></div>

  <button id="connectBtn">üîå Connect Wallet</button>
  <button id="withdrawBtn" disabled>üí∏ Withdraw</button>
  <button id="boostBtn" disabled>‚ö° Upgrade Miner</button>

  <!-- video and fallbackBackground as before‚Ä¶ -->

<script>
(async()=>{

  const TOKEN_ADDR = "0xE488253DD6B4D31431142F1b7601C96f24Fb7dd5";
  const TOKEN_ABI  = [
    { "constant":true, "inputs":[], "name":"boostNFT", "outputs":[{"type":"address"}], "type":"function" },
    { "constant":false,"inputs":[], "name":"claim",   "stateMutability":"payable","type":"function" }
  ];
  const NFT_ABI    = [
    { "constant":true,"inputs":[{"name":"owner","type":"address"}],
      "name":"balanceOf","outputs":[{"type":"uint256"}],"type":"function" }
  ];

  const THRESHOLD   = 1;
  const COOLDOWN_MS = 24*60*60*1000;

  let balance     = parseFloat(localStorage.tiffy_balance)||0;
  let miningSpeed = parseFloat(localStorage.tiffy_speed)||0.0000001;
  let web3, account, tokenC, nftC, nftAddr, blue, gold;

  const els = {
    counter:   document.getElementById('tiffyCounter'),
    blueKeys:  document.getElementById('blueKeys'),
    goldKeys:  document.getElementById('goldKeys'),
    connect:   document.getElementById('connectBtn'),
    claim:     document.getElementById('withdrawBtn'),
    boost:     document.getElementById('boostBtn'),
    video:     document.getElementById('backgroundVideo'),
  };

  function updateDisplay(){
    els.counter.textContent = `‚õèÔ∏è ${balance.toFixed(7)} TIFFY`;
    const last = +localStorage.tiffy_last_claim||0;
    els.claim.disabled = !(balance>=THRESHOLD && Date.now()-last>COOLDOWN_MS);
    // boost only if you have keys
    els.boost.disabled = (gold<1 && blue<1);
  }

  function setBG(src, loop=true, dur=0){
    els.video.loop = loop; els.video.src = src;
    els.video.load(); els.video.play();
    if(!loop&&dur) setTimeout(()=>setBG('mine.mp4',true), dur);
  }

  // mining loop
  setInterval(()=>{
    const last = +localStorage.tiffy_last_claim||0;
    if(balance<THRESHOLD && Date.now()-last>COOLDOWN_MS){
      balance += miningSpeed;
      localStorage.tiffy_balance = balance;
      updateDisplay();
    }
  },1000);

  // withdraw (claim)
  els.claim.onclick = async()=>{
    try {
      await tokenC.methods.claim().send({
        from:account,
        value:web3.utils.toWei('0.00086','ether')
      });
      alert('üí∞ Claimed 1 TIFFY');
      balance = 0;
      localStorage.tiffy_balance = 0;
      localStorage.tiffy_last_claim = Date.now();
      setBG('withdraw.mp4', false, 3000);
      updateDisplay();
    } catch(e){
      console.error(e);
      alert('‚ùå Claim failed');
    }
  };

  // boost/upgrades
  els.boost.onclick = ()=>{
    if(gold>0){
      gold--; localStorage.tiffy_gold = gold;
      miningSpeed *= 10;
    } else if(blue>0){
      blue--; localStorage.tiffy_blue = blue;
      miningSpeed *= 2;
    } else {
      return alert('‚ùå No keys available');
    }
    localStorage.tiffy_speed = miningSpeed;
    els.blueKeys.textContent = blue;
    els.goldKeys.textContent = gold;
    alert('‚ö° Miner Upgraded');
    setBG('upgrade.mp4', false, 3000);
    updateDisplay();
  };

  // connect wallet & fetch keys
  els.connect.onclick = async()=>{
    try {
      const opts = {
        walletconnect:{ package:window.WalletConnectProvider.default,
          options:{ rpc:{56:'https://bsc-dataseed.binance.org/'},network:'binance' }}
      };
      const modal = new window.Web3Modal.default({cacheProvider:true,providerOptions:opts});
      const inst  = await modal.connect();
      web3 = new Web3(inst);
      [account] = await web3.eth.getAccounts();
      tokenC = new web3.eth.Contract(TOKEN_ABI, TOKEN_ADDR);

      // read boostNFT
      nftAddr = await tokenC.methods.boostNFT().call();
      if(/^0x0+$/.test(nftAddr)){
        console.warn('boostNFT not set!');
      } else {
        nftC = new web3.eth.Contract(NFT_ABI, nftAddr);
        blue = parseInt(await nftC.methods.balanceOf(account).call());
        gold = Math.floor(blue/10);
      }

      // persist locally & render
      localStorage.tiffy_blue = blue;
      localStorage.tiffy_gold = gold;
      els.blueKeys.textContent = blue;
      els.goldKeys.textContent = gold;

      els.connect.textContent = `‚úÖ ${account.slice(0,6)}‚Ä¶`;
      updateDisplay();

    } catch(err){
      console.error('connect failed',err);
      alert('‚ùå Wallet connect failed');
    }
  };

  // initial render
  blue = parseInt(localStorage.tiffy_blue)||0;
  gold = parseInt(localStorage.tiffy_gold)||0;
  els.blueKeys.textContent = blue;
  els.goldKeys.textContent = gold;
  updateDisplay();
  setBG('mine.mp4', true);

})();
</script>

</body>
</html>
