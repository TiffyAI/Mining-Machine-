<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TiffyAI Miner</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>
  <script src="https://unpkg.com/web3modal"></script>
  <style>
    html, body { margin:0; padding:0; overflow:hidden; height:100%; width:100%; }
    body { font-family:'Segoe UI',sans-serif; color:#00ffe7;
      display:flex; flex-direction:column; align-items:center; justify-content:center; }
    #backgroundVideo, #fallbackBackground { position:fixed; top:0; left:0; width:100vw; height:97vh; object-fit:cover; }
    #fallbackBackground { background:url('miner.jpg') center/cover no-repeat; z-index:-2; }
    #backgroundVideo { z-index:-1; }
    h1 { font-size:2.5rem; text-shadow:0 0 10px #00ffe7; margin:1rem 0; }
    .status { margin:0.5rem; font-size:1.2rem; text-shadow:0 0 5px #00ffe7; }
    button { background:#00ffe7; color:#000; border:none; padding:0.8rem 1.5rem; margin:0.5rem;
      font-size:1rem; border-radius:8px; cursor:pointer; transition:0.3s; }
    button:hover { background:#00c6b0; }
    button:disabled { background:gray; cursor:not-allowed; }
  </style>
</head>
<body>

  <div id="fallbackBackground"></div>
  <video id="backgroundVideo" autoplay muted loop playsinline>
    <source src="mine.mp4" type="video/mp4">
  </video>

  <h1>üõ† TiffyAI Miner</h1>
  <div id="tiffyCounter" class="status">‚õèÔ∏è 0.0000000 TIFFY</div>
  <div id="blueKeys"   class="status">üîë Blue Keys: 0</div>
  <div id="goldKeys"   class="status">ü•á Gold Keys: 0</div>

  <button id="connectBtn">üîå Connect Wallet</button>
  <button id="withdrawBtn" disabled>üí∏ Claim 1 TIFFY</button>
  <button id="boostBtn">‚ö° Boost Power</button>

  <script>
(async()=>{
  const CONTRACT_ADDRESS = "0xE488253DD6B4D31431142F1b7601C96f24Fb7dd5";
  const TOKEN_ABI = [
    { "constant":true,  "inputs":[], "name":"boostNFT","outputs":[{"name":"","type":"address"}],"type":"function" },
    { "constant":false, "inputs":[], "name":"claim",   "outputs":[],"stateMutability":"payable","type":"function" }
  ];
  const NFT_ABI = [
    { "constant":true,"inputs":[{"name":"owner","type":"address"}],
      "name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"type":"function" }
  ];

  const COUNTER_KEY    = 'tiffy_balance';
  const SPEED_KEY      = 'tiffy_speed';
  const LAST_CLAIM_KEY = 'tiffy_last_claim';
  const THRESHOLD      = 1;
  const COOLDOWN_MS    = 24*60*60*1000;

  let balance     = parseFloat(localStorage.getItem(COUNTER_KEY)) || 0;
  let miningSpeed = parseFloat(localStorage.getItem(SPEED_KEY))   || 0.0000001;
  let web3, account, tokenC, nftC;

  const el = {
    counter:  document.getElementById('tiffyCounter'),
    blueKeys: document.getElementById('blueKeys'),
    goldKeys: document.getElementById('goldKeys'),
    connect:  document.getElementById('connectBtn'),
    claim:    document.getElementById('withdrawBtn'),
    boost:    document.getElementById('boostBtn'),
    video:    document.getElementById('backgroundVideo')
  };

  function updateDisplay(){
    el.counter.textContent = `‚õèÔ∏è ${balance.toFixed(7)} TIFFY`;
    const last = +localStorage.getItem(LAST_CLAIM_KEY)||0;
    el.claim.disabled = !(balance>=THRESHOLD && Date.now()-last>COOLDOWN_MS);
  }

  function setBG(src, loop=true, dur=0){
    el.video.loop = loop;
    el.video.src  = src;
    el.video.load();
    el.video.play();
    if(!loop && dur>0) setTimeout(()=>setBG('mine.mp4',true), dur);
  }

  // mining ticker
  setInterval(()=>{
    const last = +localStorage.getItem(LAST_CLAIM_KEY)||0;
    if(balance<THRESHOLD && Date.now()-last>COOLDOWN_MS){
      balance += miningSpeed;
      localStorage.setItem(COUNTER_KEY, balance);
      updateDisplay();
    }
  }, 1000);

  // boost = double speed
  el.boost.onclick = ()=>{
    miningSpeed *= 2;
    localStorage.setItem(SPEED_KEY, miningSpeed);
    alert('‚ö° Mining Power Upgraded');
    setBG('upgrade.mp4', false, 3000);
  };

  // connect wallet + fetch keys
  el.connect.onclick = async ()=>{
    try {
      const providerOpts = {
        walletconnect:{
          package: window.WalletConnectProvider.default,
          options:{ rpc:{56:'https://bsc-dataseed.binance.org/'}, network:'binance' }
        }
      };
      const modal = new window.Web3Modal.default({ cacheProvider:true, providerOptions });
      const instance = await modal.connect();
      web3 = new Web3(instance);
      [account] = await web3.eth.getAccounts();

      tokenC = new web3.eth.Contract(TOKEN_ABI, CONTRACT_ADDRESS);
      const nftAddr = await tokenC.methods.boostNFT().call();
      console.log('‚Üí boostNFT address:', nftAddr);
      if(/^0x0+$/.test(nftAddr)){
        console.warn('boostNFT is zero address ‚Äì did you `setNFTBoostContract`?');
        el.blueKeys.textContent = 'üîë Blue Keys: N/A';
        el.goldKeys.textContent = 'ü•á Gold Keys: N/A';
      } else {
        nftC = new web3.eth.Contract(NFT_ABI, nftAddr);
        const blue = parseInt(await nftC.methods.balanceOf(account).call());
        const gold = Math.floor(blue/10);
        el.blueKeys.textContent = `üîë Blue Keys: ${blue}`;
        el.goldKeys.textContent = `ü•á Gold Keys: ${gold}`;
      }

      el.connect.textContent = `‚úÖ ${account.slice(0,6)}‚Ä¶Connected`;
      updateDisplay();
    } catch(err){
      console.error('Connection or key‚Äëfetch failed:', err);
      alert('‚ùå Wallet connect or key lookup failed ‚Äì check console');
    }
  };

  // claim via smart‚Äëcontract
  el.claim.onclick = async ()=>{
    if(!tokenC||!account) return alert('‚ùå Please Connect First');
    try {
      await tokenC.methods.claim().send({
        from:account,
        value:web3.utils.toWei('0.00086','ether') // your BNB fee
      });
      alert('üí∞ Claimed 1 TIFFY');
      localStorage.setItem(COUNTER_KEY, 0);
      localStorage.setItem(LAST_CLAIM_KEY, Date.now());
      balance = 0;
      updateDisplay();
      setBG('withdraw.mp4', false, 3000);
    } catch(e){
      console.error('Claim error:', e);
      alert('‚ùå Claim failed ‚Äì check BNB & cooldown');
    }
  };

  // initial draw
  updateDisplay();
  setBG('mine.mp4', true);

})();
</script>

</body>
</html>
